package com.easycart.controller.customer;

import java.io.IOException;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.view.RedirectView;

import com.easycart.controller.BaseController;
import com.easycart.controller.admin.companyinfo.logic.CompanyInfoLogic;
import com.easycart.controller.admin.login.interceptor.RemoteInfo;
import com.easycart.controller.admin.order.OrderSearchForm;
import com.easycart.controller.cart.ConfirmView;
import com.easycart.controller.cart.logic.CartLogic;
import com.easycart.controller.customer.logic.CustomerLoginLogic;
import com.easycart.controller.index.MenuView;
import com.easycart.controller.index.logic.IndexLogic;
import com.easycart.db.entity.Cart;
import com.easycart.db.entity.Customer;
import com.easycart.db.entity.Order;
import com.easycart.utils.DateHelper;
import com.easycart.utils.IdentifyCode;
import com.easycart.utils.Md5;
import com.easycart.utils.Page;
import com.msg.SendSMS;

/**
 * web index
 * @author yaoliang
 * 24-12-2015
 */
@Controller
@RequestMapping(value="/customer")
public class CustomerLoginController  extends BaseController{
	private static Logger logger = LogManager.getLogger(CustomerLoginController.class);
	
	@Autowired
	CustomerLoginLogic customerLoginLogic;
	@Autowired
	IndexLogic indexLogic;
	@Autowired 
	CompanyInfoLogic companyInfoLogic;
	@Autowired
	CartLogic cartLogic;
	
	private String msg = "验证码错误";
	
	@RequestMapping(value="/")
	public ModelAndView index(HttpServletRequest request){
		ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
		modelAndView.addObject("customerForm", new CustomerForm());
		//获取SESSION数据
		List<Cart> cartList = this.getAllProductFromSession(-1,0, request);
		//购物车产品数量
		modelAndView.addObject("productInCartNum", super.getCartNum(cartList));
		
		//获取菜单
		List<MenuView> menuList = indexLogic.getMenus();
		modelAndView.addObject("menuViewList", menuList);
		//显示登陆还是注册0 登陆，1注册
		modelAndView.addObject("flag", 0);
		return modelAndView;
	}
	
	/**
	 * 客户登陆
	 * @param phone
	 * @param password
	 * @param request
	 * @return
	 */
	@RequestMapping(value="/login",method=RequestMethod.POST)
	public ModelAndView login(HttpServletRequest request,@ModelAttribute(value="customerForm") @Valid CustomerForm customerForm,BindingResult br){
		logger.error("login");
		ModelAndView modelAndView = null;
		
		if(br.hasFieldErrors()){
			return new ModelAndView("web/customer/sign_up");
		}
		HttpSession session = request.getSession();
		
		if(session.getAttribute(request.getRemoteAddr())!=null){
			RemoteInfo remoteInfo = (RemoteInfo) session.getAttribute(request.getRemoteAddr());
			remoteInfo.setTryTimes(remoteInfo.getTryTimes()+1);
			if(remoteInfo.getTryTimes()>3 && DateHelper.getTime()<remoteInfo.getExpireTime()){
				modelAndView = new ModelAndView("web/customer/sign_up");
				modelAndView.addObject("msg", "密码错误次数过多，15分钟后尝试。");
				return modelAndView;
			}
			if(DateHelper.getTime()>remoteInfo.getExpireTime())
				session.setAttribute(request.getRemoteAddr(), new RemoteInfo());
		}else{
			RemoteInfo ri = new RemoteInfo();
			ri.setHost(request.getRemoteAddr());
			session.setAttribute(request.getRemoteAddr(), ri);
		}
		
		Customer customer = customerLoginLogic.login(customerForm.getPhone(), Md5.getMd5String(customerForm.getPassword()));
		if(customer==null){
			modelAndView = index(request);
		}else{
			modelAndView = new ModelAndView(new RedirectView(request.getContextPath()+"/customer/order/"));
			request.getSession().setAttribute(SESSION_CUSTOMER, customer);
			session.removeAttribute(request.getRemoteAddr());
		}
		
		return modelAndView;
	}
	
	/**
	 * 我的订单
	 * @param request
	 * @param customerForm
	 * @param br
	 * @return
	 */
	@RequestMapping(value="/order/")
	public ModelAndView order(HttpServletRequest request,
			@ModelAttribute(value="customerForm") @Valid OrderSearchForm orderSearchForm,BindingResult br,
			@RequestParam(value="pageNum",required=false,defaultValue="1") int pageNum){
		
		logger.info("order");
		ModelAndView modelAndView = new ModelAndView("web/customer/oder_management");
		Customer customer = (Customer)request.getSession().getAttribute(SESSION_CUSTOMER);
		
		//获取SESSION数据
		List<Cart> cartList = this.getAllProductFromSession(-1,0, request);
		//购物车产品数量
		modelAndView.addObject("productInCartNum", super.getCartNum(cartList));
		modelAndView.addObject("productInCartPrice", super.getCartPrice(cartList,customer));
		//获取菜单
		List<MenuView> menuList = indexLogic.getMenus();
		modelAndView.addObject("menuViewList", menuList);
		
		//获取订单总数
		orderSearchForm.setCustomerId(((Customer)request.getSession().getAttribute(SESSION_CUSTOMER)).getId());
		Page page = new Page(pageNum,customerLoginLogic.getOrderCount(orderSearchForm, new Page()));
		
		page.setPageNum(pageNum);
		modelAndView.addObject("page", page);
		modelAndView.addObject("customer", customer);
		modelAndView.addObject("orderViewList", customerLoginLogic.getOrderViewList(orderSearchForm, page));
		
		return modelAndView;
	}
	
	/**
	 * 订单支付链接
	 * @param request
	 * @param customerForm
	 * @param 
	 * @return ModelAndView
	 */
	@RequestMapping(value="/pay/{orderId}")
	public ModelAndView pay(HttpServletRequest request,@PathVariable(value="orderId") int orderId){
		
		logger.info("order");
		ModelAndView modelAndView = new ModelAndView("web/cart/checkout");
		Customer customer = (Customer)request.getSession().getAttribute(SESSION_CUSTOMER);
		//获取SESSION数据
		List<Cart> cartList = this.getAllProductFromSession(-1,0, request);
		//购物车产品数量
		modelAndView.addObject("productInCartNum", super.getCartNum(cartList));
		modelAndView.addObject("productInCartPrice", super.getCartPrice(cartList,customer));
		//获取菜单
		List<MenuView> menuList = indexLogic.getMenus();
		modelAndView.addObject("menuViewList", menuList);
		
		//获取订单
		Order  order = customerLoginLogic.getOrderbyId(orderId,customer.getId());
		
		if(order!=null){
			ConfirmView confirmView = new ConfirmView();
			confirmView.setTotalFreight(order.getTotalFreight());
			confirmView.setTotalProductPrice(order.getTotalProductPrice());
			modelAndView.addObject("confirmView", confirmView);
			
			modelAndView.addObject("orderId", order.getId());
		}
		
		modelAndView.addObject("customer", customer);
		modelAndView.addObject("companyInfo",companyInfoLogic.getCompanyInfo());
		return modelAndView;
	}
	
	/**
	 * 取消订单
	 * @param orderId
	 * @return
	 */
	@RequestMapping(value="/order/cancel/{id}")
	@ResponseBody
	public String cancelOrder(@PathVariable(value="id") int orderId){
		String ret = "success";
		//取消订单
		customerLoginLogic.cancelOrder(orderId);
		return ret;
	}
	
	/**
	 * 用户跳转页面
	 * @param request
	 * @param customerForm
	 * @param br
	 * @return
	 */
	@RequestMapping(value="/info")
	public ModelAndView info(HttpServletRequest request){
		logger.info("info");
		ModelAndView modelAndView = new ModelAndView("web/customer/user_info");
		Customer customer = (Customer)request.getSession().getAttribute(SESSION_CUSTOMER);
		//获取SESSION数据
		List<Cart> cartList = this.getAllProductFromSession(-1,0, request);
		//购物车产品数量
		modelAndView.addObject("productInCartNum", super.getCartNum(cartList));
		modelAndView.addObject("productInCartPrice", super.getCartPrice(cartList,customer));
		//获取菜单
		List<MenuView> menuList = indexLogic.getMenus();
		modelAndView.addObject("menuViewList", menuList);
		modelAndView.addObject("customer", customer);
		return modelAndView;
	}
	
	/**
	 * 注册跳转
	 * @param request
	 * @param customerForm
	 * @param br
	 * @return ModelAndView
	 */
	@RequestMapping(value="/register",method=RequestMethod.GET)
	public ModelAndView register(HttpServletRequest request){
		logger.info("login");
		Customer customer = (Customer)request.getSession().getAttribute(SESSION_CUSTOMER);

		ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
		modelAndView.addObject("customerForm", new CustomerForm());
		//获取SESSION数据
		List<Cart> cartList = this.getAllProductFromSession(-1,0, request);
		//购物车产品
		modelAndView.addObject("productInCartNum", super.getCartNum(cartList));
		modelAndView.addObject("productInCartPrice", super.getCartPrice(cartList,customer));
		
		//获取菜单
		List<MenuView> menuList = indexLogic.getMenus();
		modelAndView.addObject("menuViewList", menuList);
		//显示登陆还是注册0 登陆，1注册
		modelAndView.addObject("flag", 1);
		return modelAndView;
	
	}
	/**
	 * 注册保存
	 * @param request
	 * @param customerForm
	 * @param br
	 * @return ModelAndView
	 */
	@RequestMapping(value="/register/save",method=RequestMethod.POST)
	public ModelAndView registerSave(HttpServletRequest request,@ModelAttribute(value="customerForm") @Valid CustomerForm customerForm,BindingResult br){
		logger.error("login");
		

		if(br.hasErrors()){
			ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
			//显示登陆还是注册0 登陆，1注册
			modelAndView.addObject("flag", 1);
			return modelAndView;
		}
		
		/**
		 * 
		 */
		HttpSession session = request.getSession();
		IdentifyCode identifyCode = (IdentifyCode)session.getAttribute("identifyCode");
		boolean flag = true;
		if(identifyCode!=null){
			if(!identifyCode.getIdentifyCode().equals(customerForm.getIdentifyCode())){
				flag = false;
			}
		}else{
			flag = false;
		}
		if(flag){
			Customer customer = customerLoginLogic.retrieve(customerForm);
			request.getSession().setAttribute(SESSION_CUSTOMER, customer);
			return new ModelAndView(new RedirectView(request.getContextPath()+"/"));
		}else{
			ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
			//显示登陆还是注册0 登陆，1注册
			modelAndView.addObject("flag", 1);
			modelAndView.addObject("msg", msg);
			return modelAndView;
		}
		
	}
	
	
	/**
	 * 找回密码
	 * @param request
	 * @param customerForm
	 * @param br
	 * @return ModelAndView
	 */
	@RequestMapping(value="/retrieve",method=RequestMethod.POST)
	public ModelAndView retrieve(HttpServletRequest request,@ModelAttribute(value="customerForm") @Valid CustomerForm customerForm,BindingResult br){
		logger.info("retrieve");
		
		if(br.hasErrors()){
			ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
			//显示登陆还是注册0 登陆，1注册
			modelAndView.addObject("flag", 0);
			return modelAndView;
		}
		
		HttpSession session = request.getSession();
		
		IdentifyCode identifyCode = (IdentifyCode)session.getAttribute("identifyCode");
		boolean flag = true;
		if(identifyCode!=null){
			if(!identifyCode.getIdentifyCode().equals(customerForm.getIdentifyCode())){
				flag = false;
			}
		}else{
			flag = false;
		}
		if(flag){
			Customer customer = customerLoginLogic.retrieve(customerForm);
			request.getSession().setAttribute(SESSION_CUSTOMER, customer);
			return new ModelAndView(new RedirectView(request.getContextPath()+"/"));
		}else{
			ModelAndView modelAndView = new ModelAndView("web/customer/sign_up");
			//显示登陆还是注册0 登陆，1注册
			modelAndView.addObject("flag", 0);
			modelAndView.addObject("msg", msg);
			return modelAndView;
		}
		
	}
	
	
	/**
	 * 
	 * 获取短信验证码
	 */
	@ResponseBody
	@RequestMapping(value="/ajax/get/code")
	public void code(HttpServletRequest request,@RequestParam(value="phone") String phone){
		logger.debug("code");
		HttpSession session = request.getSession();
		IdentifyCode identifyCode = (IdentifyCode)session.getAttribute("identifyCode");
		
		boolean flag = false;
		if(identifyCode != null){
			//控制1分钟只能发送一次
			if(DateHelper.getTime()>identifyCode.getExpireTime()){
				flag = true;
			}
		}else{
			flag = true;
		}
		
		if(flag){
			SendSMS sendSmg = new SendSMS();
			String code = sendSmg.getRandomNum();
			sendSmg.send(phone, code);
			session.setAttribute("identifyCode", new IdentifyCode(code));
		}
	}
	/**
	 * 检查电话是否存在
	 * 
	 */
	@ResponseBody
	@RequestMapping(value="/ajax/check/phone")
	public String checkPhone(@RequestParam(value="phone") String phone){
		logger.info("checkPhone" );
		String ret = "yes";
		
		Customer customer = customerLoginLogic.getCustiomerByPhone(phone);
		if(customer == null){
			ret = "no";
		}
		return ret;
	}
	
	
	/**
	 * 退出
	 * @param request
	 * @param response
	 * @throws IOException
	 */
	@RequestMapping(value="/logout")
	public void logout(HttpServletRequest request,HttpServletResponse response) throws IOException{
		logger.info("logout" );
		request.getSession().removeAttribute(SESSION_CUSTOMER);
		request.getSession().removeAttribute(request.getRemoteHost());
		response.sendRedirect(request.getContextPath()+"/");
	}

}
